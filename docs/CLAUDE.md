# CLAUDE.md - Biosphere Jar Development Log

## Overview
This document chronicles the AI-assisted development of **Biosphere Jar**, a 2D ecosystem simulation game built in Godot 4.x. The project follows a structured implementation plan divided into four phases.

**Current Status:** Phase 2 Complete - Visualization and UI integrated with core simulation

---

## Project Organization

**Directory Structure (after reorganization):**
```
biosphere-sim/
├── scripts/          # All GDScript files
│   ├── EcosystemManager.gd
│   ├── PopulationVisualizer.gd
│   ├── UIManager.gd
│   └── Creature.gd
├── scenes/           # All scene files (.tscn)
│   ├── creature.tscn
│   └── main_scene.tscn
├── docs/             # Documentation
│   └── CLAUDE.md
├── assets/           # Visual and audio assets
│   └── icon.svg
└── project.godot     # Project configuration
```

## Coding Conventions & Lessons Learned

### Scene File Syntax (Godot 4.x Format)

**Key corrections discovered when fixing corrupt .tscn files:**

1. **Resource References Format**
   ```
   [ext_resource type="Script" uid="uid://dfc6d4lpiqnwx" path="res://Creature.gd" id="1_bnn61"]
   script = ExtResource("1_bnn61")
   ```
   - UIDs are auto-generated by Godot editor (unavoidable - 16-char hex strings)
   - Reference uses string ID (NOT numeric - "1_bnn61" not "1")
   - Path should be relative to project root (res://)
   - **NOTE:** Godot editor auto-corrects paths; if scripts are moved to subdirectories, scenes must be re-linked in Inspector

2. **Color Property Format**
   ```
   color = Color(0.2, 0.8, 0.3019608, 1)
   ```
   - Uses Color() constructor with RGBA floats (0.0-1.0 range)
   - NOT "Color.GREEN" or hex notation in .tscn files

3. **Control Node Properties** (Required in Godot 4)
   ```
   [node name="Label" type="Label" parent="Container"]
   layout_mode = 2  # Essential for all Control nodes
   ```
   - `layout_mode = 2` is required for any Control node child
   - Missing this causes UI layout to fail silently

4. **Node Parent References**
   ```
   [node name="Child" type="Node2D" parent="."]       # Direct child
   [node name="GrandChild" type="Node" parent="Child"] # Nested child
   ```

5. **Property Assignment in .tscn**
   - Script-attached node properties work differently
   - Use `script = ExtResource(...)` to attach scripts
   - Other properties set directly on the node definition

### What Caused Original Corruption

My hand-written .tscn files had these errors:
1. ❌ `script = ExtResource("Script_1")` → ✓ `script = ExtResource("1_bnn61")`
2. ❌ Node named `"Visual"` → ✓ Node named `"ColorRect"` (correct type name)
3. ❌ Missing `layout_mode = 2` on Control children
4. ❌ Potentially missing `parent="."` on some nodes
5. ❌ Color format might have been incorrect

### Validated .tscn Syntax from Working Files

**From creature.tscn (verified working):**
```
[gd_scene load_steps=2 format=3 uid="uid://dpobn4ydieo40"]

[ext_resource type="Script" uid="uid://dfc6d4lpiqnwx" path="res://Creature.gd" id="1_bnn61"]

[node name="Creature" type="Node2D"]
script = ExtResource("1_bnn61")

[node name="ColorRect" type="ColorRect" parent="."]
offset_left = -4.0
offset_top = -4.0
offset_right = 4.0
offset_bottom = 4.0
color = Color(0.2, 0.8, 0.3019608, 1)

[node name="Sprite2D" type="Sprite2D" parent="."]
```

**Key observations:**
- `load_steps=2` (1 ext_resource + 1 node)
- ColorRect doesn't need `layout_mode` when it's not in a Container
- Float values use `.0` notation
- Color format: `Color(r, g, b, a)` with 4 decimal values
- Parent nodes use `parent="."` for root children

**From main_scene.tscn (partial, verified working):**
```
[gd_scene load_steps=2 format=3 uid="uid://2eabspk6mkpk"]

[ext_resource type="Script" uid="uid://dk6tkenuy2552" path="res://EcosystemManager.gd" id="1_0f027"]

[node name="MainScene" type="Node2D"]
script = ExtResource("1_0f027")

[node name="VisualContainer" type="Node2D" parent="."]

[node name="Algae" type="Node2D" parent="VisualContainer"]

[node name="UI" type="CanvasLayer" parent="."]

[node name="VBoxContainer" type="VBoxContainer" parent="UI"]
offset_left = 10.0
offset_top = 10.0
offset_right = 210.0
offset_bottom = 255.0

[node name="OxygenLabel" type="Label" parent="UI/VBoxContainer"]
layout_mode = 2
text = "Oxygen:"

[node name="OxygenBar" type="ProgressBar" parent="UI/VBoxContainer"]
layout_mode = 2
max_value = 2500.0
value = 2100.0
```

**Key observations:**
- Control nodes (Label, ProgressBar) REQUIRE `layout_mode = 2`
- Container nodes (VBoxContainer) require `layout_mode = 2` when they have parent containers
- `parent=` uses path notation: `"UI/VBoxContainer"` not `"UI/VBoxContainer."`
- CanvasLayer as parent enables UI rendering above 2D nodes

### Coding Standards to Follow

- **Script files:** Indent with TABS (not spaces)
- **Scene files:** ALWAYS use Godot editor to create/modify (never hand-write .tscn files)
- **References:** Let Godot editor generate UIDs automatically
- **Resource paths:** Always use `res://` prefix; update in Godot Inspector if files move
- **Property names:** Use exact Godot property names (check Inspector to verify)
- **String IDs:** Use string format for ExtResource ("1_bnn61" not 1)
- **Control nodes:** Always include `layout_mode = 2` for nodes inside containers

---

## Project Structure

### Scripts (res://scripts/)

**Core Simulation**
- **EcosystemManager.gd** - The heart of the project
  - Manages all resource pools (oxygen, CO2, nutrients, detritus, toxic waste)
  - Tracks species populations and metabolic parameters
  - Implements the complete simulation loop with 8 sequential steps
  - Uses fixed timestep (`_physics_process`) for numerical stability
  - Prints periodic console output for debugging (every 10 frames)

**Visualization**
- **PopulationVisualizer.gd** - Decoupled visual layer
  - Spawns/despawns creature sprites based on population density
  - One-way data dependency (reads only from EcosystemManager)
  - Independent visual updates with smooth animations
  - Configurable density thresholds per species

- **Creature.gd** - Individual creature animation
  - Provides bobbing and drifting movement
  - Simple time-based animation logic
  - Lightweight and reusable for all creature types

**UI Layer**
- **UIManager.gd** - HUD and data abstraction
  - Bridges simulation data to player-friendly displays
  - Abstracts complex values into intuitive indicators
  - Normalized "Water Quality" meter for toxic waste
  - Progress bars for critical resources

### Scenes (res://scenes/)

**main_scene.tscn** - Root scene structure
```
MainScene (Node2D) [script: EcosystemManager.gd]
├── VisualContainer (Node2D)
│   ├── Algae (Node2D) [script: PopulationVisualizer]
│   ├── Daphnia (Node2D) [script: PopulationVisualizer]
│   ├── Snail (Node2D) [script: PopulationVisualizer]
│   ├── Hydra (Node2D) [script: PopulationVisualizer]
│   └── Bacteria (Node2D) [script: PopulationVisualizer]
└── UI (CanvasLayer) [script: UIManager]
	└── VBoxContainer (VBoxContainer)
		├── OxygenLabel (Label)
		├── OxygenBar (ProgressBar)
		├── CO2Label (Label)
		├── NutrientLabel (Label)
		├── SoftDetritusLabel (Label)
		├── ToxicWasteLabel (Label)
		└── ToxicWasteBar (ProgressBar)
```

**creature.tscn** - Individual creature scene
```
Creature (Node2D) [script: Creature.gd]
├── ColorRect (ColorRect)
│   └── Green 8x8 rect placeholder
└── Sprite2D (Sprite2D)
	└── Empty placeholder for sprite texture
```

### Assets (res://assets/)
- **icon.svg** - Project icon (Godot default)

---

## Implementation Completed

### Phase 3: Player Interaction & Game Loop ✓
**Goal:** Implement the two-phase game loop (Setup/Simulation) and all player controls

**Deliverables Met:**
- ✓ GameState.gd autoload for global game phase management
- ✓ Setup phase organism addition/removal functions in EcosystemManager
- ✓ Expanded UIManager with phase-aware UI switching
- ✓ Time controls (Play/Pause/2x/4x/8x/Skip Ahead buttons)
- ✓ Environment controls (Light intensity and Temperature sliders)
- ✓ Phase-gated simulation (only runs during SIMULATION phase)
- ✓ Dynamic organism button creation for setup phase
- ✓ Seal jar button to transition from setup to simulation

**New Scripts:**
- **GameState.gd** (res://scripts/game_state.gd)
  - Global autoload managing game phase state
  - Tracks: SETUP vs SIMULATION phase
  - Tracks: Beginner mode toggle, tank volume

**Enhanced Scripts:**
- **EcosystemManager.gd**
  - Added: `add_organism(species_name)` - Add organism unit during setup
  - Added: `remove_organism(species_name)` - Remove organism unit during setup
  - Added: `add_resource(resource_name, amount)` - Add initial resources
  - Added: `reset_jar()` - Clear jar for new setup
  - Added: `seal_jar()` - Transition to simulation phase
  - Modified: `_physics_process()` - Now phase-aware (only simulates during SIMULATION)

- **UIManager.gd** (Complete rewrite)
  - Added: Time control handlers (play, pause, speed scaling)
  - Added: `_skip_ahead_async()` - Simulate 1 hour of gameplay instantly
  - Added: Environment slider handlers for light/temperature
  - Added: `_create_organism_buttons()` - Dynamically create setup UI
  - Added: `_update_phase_visibility()` - Show/hide UI based on game phase
  - Added: Phase-aware display logic (setup vs simulation displays)
  - Optimized: Node finding to be optional (graceful if UI elements missing)

**Key Features Implemented:**

1. **Game State Management**
   ```
   enum State { SETUP, SIMULATION }
   - enter_setup_phase()
   - enter_simulation_phase()
   - is_setup_phase() / is_simulation_phase()
   ```

2. **Setup Phase Controls**
   - Add/remove organisms one unit at a time
   - Display current organism counts
   - Add custom resource amounts
   - Reset jar to empty state
   - Seal jar to begin simulation

3. **Time Controls**
   - **Play:** Resume at 1x speed (Engine.time_scale = 1.0)
   - **Pause:** Freeze simulation (Engine.time_scale = 0.0)
   - **2x/4x/8x:** Accelerated simulation playback
   - **Skip Ahead:** Fast-forward 1 hour of gameplay
	 - Runs advance_simulation() in tight loop without rendering
	 - Preserves time_scale after completion
	 - Useful for long-term ecosystem testing

4. **Environment Controls**
   - **Light Intensity Slider:** 0.0 (dark) to 2.0 (bright)
	 - Affects algae photosynthesis rate
	 - Real-time adjustment during simulation
   - **Temperature Slider:** 15°C to 30°C
	 - Placeholder for future metabolism scaling
	 - Real-time adjustment during simulation

5. **Phase-Aware UI**
   - **Setup Phase Display:**
	 - Organism buttons with +/- controls
	 - Resource display (read-only)
	 - Seal button
	 - Time controls hidden
   - **Simulation Phase Display:**
	 - Time controls visible
	 - Environment sliders visible
	 - Organism buttons hidden
	 - Full resource HUD active

### Phase 1: Core Simulation Engine ✓
**Goal:** Create a non-visual, purely mathematical simulation

**Deliverables Met:**
- ✓ EcosystemManager.gd with all resource pools and species data
- ✓ Fixed timestep logic using `_physics_process()`
- ✓ Complete 8-step simulation cycle:
  1. Delta trackers initialization
  2. Producers (photosynthesis with light limitation)
  3. Decomposers (bacteria processing detritus)
  4. Hard detritus decay
  5. Consumers (predation food web)
  6. Metabolism & death (respiration, waste, decomposition)
  7. Toxicity feedback (affects death rates)
  8. Delta application with safety clamps

- ✓ Console output showing changing values every 10 frames

**Key Features:**
- Data-driven design: All species params in dictionaries (easily extensible)
- Closed-system balance: Resource conservation with realistic cycles
- Food web defined as nested dictionaries for flexibility
- Tank volume scaling affects waste dilution

### Phase 2: Visualization and UI ✓
**Goal:** Connect simulation to visual front-end

**Deliverables Met:**
- ✓ PopulationVisualizer.gd with dynamic sprite management
- ✓ UIManager.gd with resource display and data abstraction
- ✓ Creature scene with simple visual representation
- ✓ MainScene.tscn with complete hierarchy
- ✓ Main scene set in project.godot

**Architecture Principles Applied:**
- Simulation-first: Rendering completely decoupled from physics
- Data abstraction: UI translates raw simulation values to player-friendly metrics
- One-way dependencies: Visuals read-only from simulation

---

## Design Decisions & Rationale

### Fixed Timestep Physics Loop
Using `_physics_process()` instead of `_process()` ensures:
- Deterministic, reproducible simulation results
- Stable numerical calculations
- Predictable behavior for player testing and balancing

### Data-Driven Species Parameters
All species rules stored in dictionaries (`populations`, `species_params`, `food_web`):
- **Advantage:** Easy iteration and balancing without code changes
- **Advantage:** Inspector-editable parameters (via @export)
- **Future:** Simple JSON/CSV import for external balancing tools

### Decoupled Visualization
PopulationVisualizer reads-only from EcosystemManager:
- **Advantage:** Visuals never affect simulation logic
- **Advantage:** Simulation runs identically with/without rendering
- **Advantage:** Easy to add new visual features without touching core logic

### Abstract Resource Representation
Toxic waste normalized as "Water Quality":
- **Advantage:** Reduces cognitive load on players
- **Advantage:** Same metric meaningful across different tank sizes
- **Advantage:** Provides color-coded feedback (good/fair/critical)

---

## Simulation Logic Highlights

### Photosynthesis (Step 2)
```
producer_rate = algae_biomass * 0.02 * light_intensity
producer_rate *= min(co2_available, nutrient_available)  # Limiting resource
```
- Limited by least abundant resource (CO2 or nutrients)
- Light intensity directly affects growth rate
- Oxygen production from photosynthesis

### Nitrogen Cycle (Step 3)
```
Bacteria consume soft_detritus → produces toxic_waste + nutrients
Also: Bacteria consume toxic_waste → produces nutrients
```
- Core of the ecosystem self-regulation
- Balances growth and decay

### Food Web (Step 5)
```
feeding_rate = predator_biomass * prey_biomass * interaction_rate
predator gains: feeding_rate * 0.3  (energy transfer efficiency loss)
```
- Realistic energy loss through trophic levels
- Supports both living prey and detritus as food sources

### Toxicity Feedback (Step 7)
```
toxicity_level = toxic_waste / (tank_volume * 50.0)
if toxicity_level > 1.0:
	organism death increases with toxicity_sensitivity
```
- Tank size matters: 1L jar gets poisoned faster than 10L
- Species have varying tolerance

---

## Species Configuration

Current species in the simulation:

| Species | Unit Biomass | Soft/Hard Ratio | Respiration | Death Rate | Toxicity Sensitivity |
|---------|------------|-----------------|------------|-----------|---------------------|
| Algae | 5.0 | 4.0/1.0 | 0.005 | 0.01 | 0.1 (tolerant) |
| Daphnia | 2.0 | 1.5/0.5 | 0.015 | 0.025 | 0.4 (sensitive) |
| Snail | 15.0 | 5.0/10.0 | 0.01 | 0.02 | 0.2 |
| Hydra | 8.0 | 6.0/2.0 | 0.02 | 0.03 | 0.3 |
| Bacteria | 1.0 | 0.8/0.2 | 0.01 | 0.015 | 0.0 (immune) |

Food Web:
- Hydra → eats Daphnia (rate: 0.01)
- Daphnia → eats Algae (rate: 0.008)
- Snail → eats Algae (rate: 0.005) + Soft Detritus (rate: 0.003)
- Bacteria → eats Soft Detritus (rate: 0.02) + Toxic Waste (rate: 0.01)

---

## Remaining Work

### Phase 3: Player Interaction & Game Loop
**TODO:**
- Create GameState.gd autoload for setup/simulation phases
- Implement Setup Phase toolbox UI
- Add time controls (play/pause/fast-forward/skip ahead)
- Environment sliders (light intensity, temperature)
- Seal jar button to transition from setup to simulation
- Camera controls (zoom, pan)

**Related Tasks:**
- Async "Skip Ahead" function for headless simulation
- Time scaling with Engine.time_scale
- UI state management based on game phase

### Phase 4: Advanced Features & Polish
**TODO:**
- Historical data logging system
- Graph visualization for population trends
- Challenge mode implementation
- Beginner mode with reduced difficulty
- Educational popups on click
- Sound effects and background music
- Screenshot/photo album feature
- Game modes (Sandbox vs Beginner)

---

## Testing Notes

### Console Output
When MainScene plays, EcosystemManager prints every 10 frames:
```
=== Simulation Frame 10 (Time: 0.17s) ===
--- Resources ---
  Oxygen: 21043.52 | CO2: 389.42 | Nutrients: 98.23
  Soft Detritus: 49.15 | Hard Detritus: 199.73 | Toxic Waste: 0.82
--- Populations ---
  Algae: 102.45 | Daphnia: 19.87 | Snail: 9.92 | Hydra: 4.98 | Bacteria: 50.12
--- Environment ---
  Light: 1.00 | Temperature: 25.0°C | Tank Volume: 5.00 L
```

### Visual Feedback
- Creatures appear as green circles with bobbing animation
- More creatures visible = higher population
- Creatures disappear when population drops

### UI Panel
- Left side of screen shows real-time resource values
- Oxygen bar fills as production occurs
- Water Quality meter changes as toxic waste accumulates
- All values update smoothly in real-time

---

## Important Notes for Future Development

### Population Scaling
`density_per_sprite` in PopulationVisualizer controls visual representation:
- `algae: 10.0` - Shows 1 sprite per 10 biomass
- `daphnia: 2.0` - Shows 1 sprite per 2 biomass
- Adjust these values to control visual clutter vs. biomass accuracy

### Tank Volume Impact
Set in EcosystemManager, affects:
- Waste dilution (larger tanks buffer toxicity better)
- Resource scaling for UI normalization
- Game difficulty (1L = hard, 10L = easy)

### Inspector Tweaking
All @export variables in EcosystemManager are tweakable:
- Resource initial values
- Species parameters (respiration, death, waste)
- Food web interaction rates
- Environmental conditions
- Tank volume

### Performance Considerations
- Simulation runs at fixed timestep (60 FPS by default)
- Console printing can be disabled by changing `print_interval`
- PopulationVisualizer spawns/despawns creatures smoothly
- UIManager updates every frame (low overhead)

### Code Quality
- Comprehensive comments linking to GDD and Implementation Plan
- Clear separation of concerns (simulation/visualization/UI)
- All variable names follow GDD terminology
- Ready for external balancing and iteration

---

## References

- **Game Design Document:** Game Design Document_ Biosphere Jar.md
- **Implementation Plan:** Implementation PLan - Biosphere Jar.md
- **Design Principles:** Ecosystem Simulation Design Principles.md
- **Task Assignment:** AI Agent Task_ Implement Phase 1 of the Biosphere Jar Godot Project.md

---

## Phase 3 Gameplay Flow

### Current Gameplay Loop (After Phase 3)

1. **Start:** Game begins in SETUP phase
2. **Setup Phase:**
   - Press "+" button next to each organism to add units to the jar
   - Example: "Algae: [+][-]" adds/removes algae
   - Current organism counts displayed
   - Resource levels shown (read-only)
3. **Seal Jar:**
   - Click "Seal Jar" button to transition to SIMULATION phase
   - Simulation begins immediately
4. **Simulation Phase:**
   - **Watch:** Creatures appear/disappear as populations change
   - **Control Time:**
	 - Play (1x) / Pause (0x)
	 - 2x / 4x / 8x speed buttons
	 - Skip button: Fast-forward 1 hour
   - **Adjust Environment:**
	 - Light slider: 0 (dark) → 2 (bright) - affects algae growth
	 - Temp slider: 15°C → 30°C - placeholder for future
   - **Monitor Resources:**
	 - Oxygen bar and count
	 - CO2, Nutrients, Soft Detritus displays
	 - Water Quality meter (Good/Fair/Critical)

### Example Gameplay Session

```
1. Add 100 biomass algae
2. Add 20 biomass daphnia
3. Add 50 biomass bacteria
4. Seal jar
5. Set light to maximum (2.0)
6. Watch algae grow and daphnia graze
7. Press Skip to fast-forward 1 hour
8. Pause and observe final state
9. Adjust temp slider and resume to see ecosystem adapt
```

## Next Steps for Developer

### Immediate Next (Phase 3 Polish)
1. **Create Scene UI in Godot Editor**
   - Add TimeControls panel with Play/Pause/2x/4x/8x/Skip buttons
   - Add EnvironmentControls panel with Light and Temp sliders
   - Add SetupPanel with VBoxContainer for organism buttons
   - Connect to UIManager scripts

2. **Test Full Gameplay Loop**
   - Press Play in Godot
   - Game should start in SETUP phase
   - Add organisms via buttons
   - Seal jar
   - Verify UI switches to SIMULATION
   - Test all time controls
   - Test sliders adjust light/temperature

### Phase 4 Features
1. **Historical Data Graphing** - Track population trends over time
2. **Challenges & Game Modes** - Beginner mode, challenge scenarios
3. **Educational Popups** - Click on organisms/resources for info
4. **Audio** - Background music and SFX
5. **Screenshot Feature** - Save jar states as images

### Art & Polish
1. **Create visuals** - Replace Creature.tscn placeholder with actual sprite artwork
2. **Design UI** - Polish button/slider appearance
3. **Add animations** - Enhance creature movement and visual feedback
4. **Balance gameplay** - Adjust species parameters for interesting dynamics

---

---

## .tscn Corruption Debugging Notes

### What Happened
Initial hand-written .tscn files (Creature.tscn and MainScene.tscn) were rejected by Godot editor as corrupt. After deletion and recreation in the Godot editor, both scenes became functional.

### Root Causes Identified

**My hand-written mistakes:**
1. **Incorrect ExtResource ID format:** Used `ExtResource("Script_1")` instead of `ExtResource("1_bnn61")`
   - Godot uses string IDs with underscore-separated hex values
   - Not simple numeric indices

2. **Wrong ColorRect naming:** Named node `"Visual"` instead of `"ColorRect"`
   - Godot expects node name to match or describe the type
   - Used the actual Godot class name

3. **Missing layout_mode:** Control nodes inside VBoxContainer lacked `layout_mode = 2`
   - This is **required** in Godot 4 for proper UI layout
   - Without it, UI elements don't size/position correctly

4. **Potential uid format issues:** My manual uid values likely didn't match Godot's generation algorithm
   - UIDs must be unique and properly formatted
   - Editor auto-generates these; never hand-create them

5. **Color format inconsistency:** May have used wrong Color() format
   - Correct: `Color(0.2, 0.8, 0.3019608, 1)`
   - Must be 4 RGBA float values, not hex or named colors in .tscn

### Best Practice Lesson

**Never hand-write .tscn files. Always use Godot editor:**
- Create scenes in the Scene panel
- Arrange nodes visually
- Assign scripts through Inspector
- Save via File → Save Scene
- Editor handles all the complex UID generation and format validation

If you must edit a .tscn file manually:
1. Use an existing valid scene as template
2. Only modify node hierarchies and simple property values
3. Never modify `[ext_resource]` blocks or UIDs
4. Always validate in Godot after editing

### Lesson Impact on Future Development

All scene files will be created exclusively through the Godot editor going forward. If scenes need to be modified programmatically, they'll be done via GDScript's scene instance system, not by editing .tscn files directly.

---

**Last Updated:** 2025-10-21
**Status:** Phase 2 Complete - Scene files corrected and validated
**Godot Version:** 4.x (tested with 4.5)
**Important:** All .tscn files created/edited via Godot editor only (no hand-writing)
